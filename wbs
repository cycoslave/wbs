#!/usr/bin/env python3
import argparse
import asyncio
import json
import logging
import sys
import os

from src.core import Core

logging.basicConfig(level=logging.INFO, format='%(asctime)s %(levelname)s %(message)s')
logger = logging.getLogger(__name__)

def parse_args():
    parser = argparse.ArgumentParser(prog="wbs")
    parser.add_argument("-f", "--foreground", action="store_true")
    parser.add_argument("-c", "--config", default="config.json")
    parser.add_argument("-d", "--db-path")
    return parser.parse_args()

def load_config(config_path, db_path_override=None):
    with open(config_path) as f:
        config = json.load(f)
    if db_path_override:
        config['db']['path'] = db_path_override
    return config

def main():
    args = parse_args()
    config = load_config(args.config, args.db_path)
    os.environ['WBS_CONFIG'] = args.config
    os.environ['WBS_FOREGROUND'] = '1' if args.foreground else '0' 
    core = Core(config)
    asyncio.run(core.run())


if __name__ == '__main__':
    main()
