#!/usr/bin/env python3
# main.py - WBS Bot Entrypoint with multiprocessing
import asyncio
import json
import multiprocessing as mp
import os
import sys
from pathlib import Path

from src.irc import start_irc_process  # Expects (config, event_q, cmd_q)
from src.core import start_core_process  # New: (config, event_q, cmd_q)
from src.botnet import botnet_process  # Expects (config, queues if needed)
from src.db import init_db, seed_db

def load_config(config_path="config.json"):
    """Load configuration from JSON file."""
    with open(config_path) as f:
        return json.load(f)

async def setup_db(config):
    """Initialize and seed the database."""
    db_path = config['db']['path']
    await init_db(db_path, schema_path="db/schema.sql")
    await seed_db(db_path, config)

def run_irc_process(config, event_q, cmd_q):
    channels = config.get('channels', config['bot'].get('channels', []))
    start_irc_process(config, channels, event_q, cmd_q)  # Pass channels explicitly

def run_core_process(config, event_q, cmd_q):
    """Core process: queues -> commands/DB/botnet."""
    # Implement in src/core.py: event loop consuming event_q, sending via cmd_q
    from src.core import CoreEventLoop
    loop = CoreEventLoop(config, event_q, cmd_q)
    loop.run()  # Sync blocking loop

if __name__ == "__main__":
    mp.set_start_method('spawn', force=True)  # Cross-platform compatibility

    config = load_config()
    asyncio.run(setup_db(config))  # Shared DB init (SQLite WAL mode for multi-process)

    # IPC Queues: irc -> event_q -> core; core -> cmd_q -> irc
    event_q = mp.Queue()
    cmd_q = mp.Queue()

    processes = []

    # IRC process (network-facing)
    irc_p = mp.Process(target=run_irc_process, args=(config, event_q, cmd_q), name="irc")
    irc_p.start()
    processes.append(irc_p)

    # Core process (logic/commands)
    core_p = mp.Process(target=run_core_process, args=(config, event_q, cmd_q), name="core")
    core_p.start()
    processes.append(core_p)

    # Optional botnet process
    if config.get('botnet', {}).get('enabled'):
        botnet_p = mp.Process(target=botnet_process, args=(config,), name="botnet")
        botnet_p.start()
        processes.append(botnet_p)

    # PID file for parent process (kill tree)
    PID_FILE = Path.cwd() / "wbs.pid"
    with open(PID_FILE, "w") as f:
        f.write(str(os.getpid()))

    try:
        for p in processes:
            p.join()
    except KeyboardInterrupt:
        print("Shutting down WBS processes...")
    finally:
        # Terminate children
        for p in processes:
            if p.is_alive():
                p.terminate()
                p.join(timeout=5)
                if p.is_alive():
                    p.kill()
        # Cleanup PID
        if PID_FILE.exists():
            PID_FILE.unlink()
        sys.exit(0)